name: Convert and Sync Apps

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
  pull_request:
    paths:
      - 'apps/**'
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to convert (comma-separated or "all")'
        required: false
        default: 'all'
      sync:
        description: 'Sync to platform repositories'
        required: false
        type: boolean
        default: false

jobs:
  validate:
    name: Validate Apps
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq imagemagick
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Validate app definitions
        run: |
          ./scripts/validate-apps.sh

  convert:
    name: Convert to Platform Formats
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq imagemagick rsync
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Convert apps to all platforms
        run: |
          if [ "${{ github.event.inputs.platforms }}" == "all" ] || [ -z "${{ github.event.inputs.platforms }}" ]; then
            ./scripts/convert-to-platforms.sh
          else
            ./scripts/convert-to-platforms.sh -p ${{ github.event.inputs.platforms }}
          fi

      - name: Upload converted apps
        uses: actions/upload-artifact@v4
        with:
          name: converted-apps
          path: converted/
          retention-days: 7

  sync:
    name: Sync to Platform Repositories
    needs: convert
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.sync == 'true')
    strategy:
      matrix:
        platform:
          - casaos
          - portainer
          - runtipi
          - dockge
          - cosmos
          - umbrel
    steps:
      - name: Checkout universal-apps
        uses: actions/checkout@v4
        with:
          path: big-bear-universal-apps

      - name: Checkout platform repository
        uses: actions/checkout@v4
        with:
          repository: bigbeartechworld/big-bear-${{ matrix.platform }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: big-bear-${{ matrix.platform }}

      - name: Download converted apps
        uses: actions/download-artifact@v4
        with:
          name: converted-apps
          path: big-bear-universal-apps/converted

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: Sync apps to platform repository
        run: |
          cd big-bear-universal-apps
          ./scripts/sync-to-platforms.sh -p ${{ matrix.platform }} --force

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: big-bear-${{ matrix.platform }}
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ¤– Automated update from Universal Apps
            
            Synced apps from big-bear-universal-apps
            Generated: ${{ github.sha }}
          branch: automated-update-${{ github.run_number }}
          delete-branch: true
          title: ðŸ¤– Automated Update from Universal Apps
          body: |
            ## Automated Update
            
            This PR contains automated updates from the [Big Bear Universal Apps](https://github.com/bigbeartechworld/big-bear-universal-apps) repository.
            
            ### Platform: ${{ matrix.platform }}
            
            ### Changes
            - Synced latest app definitions
            - Updated configurations and metadata
            
            ### Validation
            - âœ… Apps validated against schema
            - âœ… Conversion completed successfully
            - âœ… Sync completed
            
            ---
            *This PR was automatically generated by the Universal Apps pipeline.*
            *Commit: ${{ github.sha }}*
            *Run: ${{ github.run_number }}*
          labels: |
            automated
            sync
          draft: false
