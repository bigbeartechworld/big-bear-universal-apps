name: Convert and Sync Apps

# Explicit permissions for security
permissions:
  contents: write      # Required for checkout and sync operations
  pull-requests: write # Required for creating and auto-merging PRs

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
  pull_request:
    paths:
      - 'apps/**'
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Specific app to convert/sync (leave empty for all apps)'
        required: false
        type: string
      platforms:
        description: 'Platforms to sync (comma-separated: casaos,portainer,runtipi,dockge,cosmos,umbrel)'
        required: false
        default: 'casaos,portainer,runtipi,dockge,cosmos,umbrel'
        type: string
      sync:
        description: 'Sync to platform repositories'
        required: false
        type: boolean
        default: false
      create_draft:
        description: 'Create PRs as drafts'
        required: false
        type: boolean
        default: false
      auto_merge:
        description: 'Enable auto-merge on PRs'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip running tests before creating PR'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (preview only, no actual changes)'
        required: false
        type: boolean
        default: false

jobs:
  validate:
    name: Validate Apps
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq imagemagick
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Validate app definitions
        run: |
          APP_ARG=""
          if [ -n "${{ github.event.inputs.app_name }}" ]; then
            APP_ARG="--app ${{ github.event.inputs.app_name }}"
          fi
          ./scripts/validate-apps.sh $APP_ARG

  convert:
    name: Convert to Platform Formats
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq imagemagick rsync
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Convert apps to platforms
        run: |
          # Determine platforms to convert
          PLATFORMS="${{ github.event.inputs.platforms }}"
          if [ -z "$PLATFORMS" ] || [ "$PLATFORMS" == "all" ]; then
            PLATFORMS="casaos,portainer,runtipi,dockge,cosmos,umbrel"
          fi
          
          # Determine if specific app
          APP_ARG=""
          if [ -n "${{ github.event.inputs.app_name }}" ]; then
            APP_ARG="--app ${{ github.event.inputs.app_name }}"
          fi
          
          # Determine if dry run
          DRY_RUN_ARG=""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            DRY_RUN_ARG="--dry-run"
          fi
          
          echo "ðŸ”„ Converting apps for platforms: $PLATFORMS"
          ./scripts/convert-to-platforms.sh -p "$PLATFORMS" $APP_ARG $DRY_RUN_ARG --verbose

      - name: Upload converted apps
        uses: actions/upload-artifact@v4
        if: github.event.inputs.dry_run != 'true'
        with:
          name: converted-apps
          path: converted/
          retention-days: 7

      - name: Generate conversion summary
        if: always()
        run: |
          echo "## ðŸ“Š Conversion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ github.event.inputs.app_name }}" ]; then
            echo "**App:** ${{ github.event.inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Apps:** All apps" >> $GITHUB_STEP_SUMMARY
          fi
          
          PLATFORMS="${{ github.event.inputs.platforms || 'all' }}"
          echo "**Platforms:** $PLATFORMS" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if converted directory exists and count apps
          if [ -d "converted" ]; then
            echo "### ðŸ”„ Converted Apps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            for platform_dir in converted/*/; do
              if [ -d "$platform_dir" ]; then
                platform=$(basename "$platform_dir")
                app_count=$(find "$platform_dir" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
                echo "- **$platform**: $app_count apps" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

  sync:
    name: Sync to Platform Repositories
    needs: convert
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.dry_run != 'true' &&
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.sync == 'true'))
    strategy:
      matrix:
        platform:
          - casaos
          - portainer
          - runtipi
          - dockge
          - cosmos
          - umbrel
    steps:
      - name: Check if platform should be synced
        id: check-platform
        run: |
          PLATFORMS="${{ github.event.inputs.platforms }}"
          CURRENT_PLATFORM="${{ matrix.platform }}"
          
          # If platforms input is empty or 'all', sync all platforms
          if [ -z "$PLATFORMS" ] || [ "$PLATFORMS" == "all" ]; then
            echo "should_sync=true" >> $GITHUB_OUTPUT
            echo "âœ… Syncing $CURRENT_PLATFORM (all platforms selected)"
          else
            # Check if current platform is in the comma-separated list
            if echo "$PLATFORMS" | grep -qw "$CURRENT_PLATFORM"; then
              echo "should_sync=true" >> $GITHUB_OUTPUT
              echo "âœ… Syncing $CURRENT_PLATFORM (explicitly selected)"
            else
              echo "should_sync=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping $CURRENT_PLATFORM (not in: $PLATFORMS)"
            fi
          fi

      - name: Checkout universal-apps
        if: steps.check-platform.outputs.should_sync == 'true'
        uses: actions/checkout@v4
        with:
          path: big-bear-universal-apps

      - name: Checkout platform repository
        if: steps.check-platform.outputs.should_sync == 'true'
        uses: actions/checkout@v4
        with:
          repository: bigbeartechworld/big-bear-${{ matrix.platform }}
          token: ${{ secrets.PLATFORM_SYNC_TOKEN }}
          path: big-bear-${{ matrix.platform }}

      - name: Download converted apps
        if: steps.check-platform.outputs.should_sync == 'true'
        uses: actions/download-artifact@v4
        with:
          name: converted-apps
          path: big-bear-universal-apps/converted

      - name: Install dependencies
        if: steps.check-platform.outputs.should_sync == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: Sync apps to platform repository
        if: steps.check-platform.outputs.should_sync == 'true'
        run: |
          cd big-bear-universal-apps
          
          # Build sync command with options
          SYNC_ARGS="-p ${{ matrix.platform }} --force"
          
          # Add app filter if specified
          if [ -n "${{ github.event.inputs.app_name }}" ]; then
            SYNC_ARGS="$SYNC_ARGS --app ${{ github.event.inputs.app_name }}"
            echo "ðŸŽ¯ Syncing specific app: ${{ github.event.inputs.app_name }}"
          fi
          
          echo "ðŸ“¦ Executing sync with args: $SYNC_ARGS"
          ./scripts/sync-to-platforms.sh $SYNC_ARGS

      - name: Create Pull Request
        if: steps.check-platform.outputs.should_sync == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          path: big-bear-${{ matrix.platform }}
          token: ${{ secrets.PLATFORM_SYNC_TOKEN }}
          commit-message: |
            ðŸ¤– Automated update from Universal Apps
            
            Synced apps from big-bear-universal-apps
            ${{ github.event.inputs.app_name && format('App: {0}', github.event.inputs.app_name) || 'All apps updated' }}
            Generated: ${{ github.sha }}
          branch: automated-update-${{ github.run_number }}
          delete-branch: true
          title: |
            ðŸ¤– Automated Update from Universal Apps${{ github.event.inputs.app_name && format(' - {0}', github.event.inputs.app_name) || '' }}
          body: |
            ## Automated Update
            
            This PR contains automated updates from the [Big Bear Universal Apps](https://github.com/bigbeartechworld/big-bear-universal-apps) repository.
            
            ### Platform: ${{ matrix.platform }}
            ${{ github.event.inputs.app_name && format('### App: {0}', github.event.inputs.app_name) || '### Scope: All apps' }}
            
            ### Changes
            - Synced latest app definitions
            - Updated configurations and metadata
            
            ### Validation
            - âœ… Apps validated against schema
            - âœ… Conversion completed successfully
            - âœ… Sync completed
            
            ---
            *This PR was automatically generated by the Universal Apps pipeline.*
            *Commit: ${{ github.sha }}*
            *Run: ${{ github.run_number }}*
          labels: |
            automated
            sync
            ${{ github.event_name == 'push' && 'automerge' || '' }}
          draft: ${{ github.event.inputs.create_draft == 'true' }}

      - name: Setup pnpm
        if: steps.check-platform.outputs.should_sync == 'true' && steps.create-pr.outputs.pull-request-number && github.event.inputs.skip_tests != 'true'
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Bun
        if: steps.check-platform.outputs.should_sync == 'true' && steps.create-pr.outputs.pull-request-number && github.event.inputs.skip_tests != 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        if: steps.check-platform.outputs.should_sync == 'true' && steps.create-pr.outputs.pull-request-number && github.event.inputs.skip_tests != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run platform tests
        if: steps.check-platform.outputs.should_sync == 'true' && steps.create-pr.outputs.pull-request-number && github.event.inputs.skip_tests != 'true'
        id: run-tests
        continue-on-error: true
        run: |
          cd big-bear-${{ matrix.platform }}
          
          # Check if platform has tests
          HAS_TESTS=false
          TEST_COMMAND=""
          
          case "${{ matrix.platform }}" in
            casaos|runtipi|umbrel|cosmos|dockge|portainer)
              # These platforms have test suites
              if [ -f "package.json" ] && grep -q '"test"' package.json; then
                HAS_TESTS=true
                
                # Determine package manager
                if [ -f "pnpm-lock.yaml" ]; then
                  TEST_COMMAND="pnpm install && pnpm test"
                elif [ -f "yarn.lock" ]; then
                  TEST_COMMAND="yarn install && yarn test"
                elif [ -f "bun.lockb" ]; then
                  TEST_COMMAND="bun install && bun test"
                else
                  TEST_COMMAND="npm install && npm test"
                fi
              fi
              ;;
          esac
          
          if [ "$HAS_TESTS" = "false" ]; then
            echo "â„¹ï¸ No tests configured for ${{ matrix.platform }} - skipping"
            echo "test_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ§ª Running tests for ${{ matrix.platform }}..."
          echo "ðŸ“ Command: $TEST_COMMAND"
          
          # Run tests and capture output
          if eval "$TEST_COMMAND" 2>&1 | tee test-output.log; then
            echo "âœ… All tests passed for ${{ matrix.platform }}"
            echo "test_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed for ${{ matrix.platform }}"
            echo "test_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload test results on failure
        if: steps.run-tests.outputs.test_status == 'failed'
        uses: actions/upload-artifact@v4
        with:
          name: test-output-${{ matrix.platform }}
          path: big-bear-${{ matrix.platform }}/test-output.log
          retention-days: 7

      - name: Set test status as skipped if tests are disabled
        if: steps.check-platform.outputs.should_sync == 'true' && steps.create-pr.outputs.pull-request-number && github.event.inputs.skip_tests == 'true'
        id: skip-tests
        run: |
          echo "test_status=skipped_by_user" >> $GITHUB_OUTPUT
          echo "âš ï¸ Tests skipped by user request"

      - name: Comment test results on PR
        if: steps.check-platform.outputs.should_sync == 'true' && steps.create-pr.outputs.pull-request-number
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.PLATFORM_SYNC_TOKEN }}
          repository: bigbeartechworld/big-bear-${{ matrix.platform }}
          issue-number: ${{ steps.create-pr.outputs.pull-request-number }}
          body: |
            ## ðŸ§ª Test Results
            
            **Platform:** ${{ matrix.platform }}
            **Status:** ${{ steps.run-tests.outputs.test_status == 'passed' && 'âœ… Passed' || steps.run-tests.outputs.test_status == 'failed' && 'âŒ Failed' || steps.skip-tests.outputs.test_status == 'skipped_by_user' && 'âš ï¸ Skipped by user' || 'â„¹ï¸ Skipped (no tests)' }}
            
            ${{ steps.run-tests.outputs.test_status == 'failed' && 'âš ï¸ **Tests failed!** Please review the workflow logs and fix the issues before merging.' || '' }}
            ${{ steps.run-tests.outputs.test_status == 'passed' && 'âœ… All tests passed successfully!' || '' }}
            ${{ steps.skip-tests.outputs.test_status == 'skipped_by_user' && 'âš ï¸ **Tests were skipped** by user request. Please ensure changes are safe to merge.' || '' }}
            
            ---
            *Workflow Run: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*

      - name: Close PR if tests failed
        if: steps.check-platform.outputs.should_sync == 'true' && steps.run-tests.outputs.test_status == 'failed'
        continue-on-error: true
        run: |
          echo "âŒ Tests failed - closing PR #${{ steps.create-pr.outputs.pull-request-number }}"
          gh pr close "${{ steps.create-pr.outputs.pull-request-number }}" --comment "Closing this PR because tests failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) and fix the issues before retrying."
        env:
          GH_TOKEN: ${{ secrets.PLATFORM_SYNC_TOKEN }}
        working-directory: big-bear-${{ matrix.platform }}

      - name: Enable auto-merge
        if: steps.check-platform.outputs.should_sync == 'true' && steps.create-pr.outputs.pull-request-number && steps.run-tests.outputs.test_status == 'passed' && (github.event.inputs.auto_merge == 'true' || github.event_name == 'push')
        run: |
          gh pr merge --auto --squash "${{ steps.create-pr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.PLATFORM_SYNC_TOKEN }}
        working-directory: big-bear-${{ matrix.platform }}

      - name: Generate sync summary
        if: steps.check-platform.outputs.should_sync == 'true' && always()
        run: |
          echo "## ðŸ”„ Sync Summary - ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.create-pr.outputs.pull-request-number }}" ]; then
            echo "âœ… **Pull Request Created:** #${{ steps.create-pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **URL:** ${{ steps.create-pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Draft:** ${{ github.event.inputs.create_draft || 'false' }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”€ **Auto-merge:** ${{ github.event.inputs.auto_merge || 'false' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add test results
            TEST_STATUS="${{ steps.run-tests.outputs.test_status }}"
            SKIP_STATUS="${{ steps.skip-tests.outputs.test_status }}"
            
            if [ "$TEST_STATUS" = "passed" ]; then
              echo "ðŸ§ª **Tests:** âœ… Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "$TEST_STATUS" = "failed" ]; then
              echo "ðŸ§ª **Tests:** âŒ Failed (PR closed)" >> $GITHUB_STEP_SUMMARY
            elif [ "$SKIP_STATUS" = "skipped_by_user" ]; then
              echo "ðŸ§ª **Tests:** âš ï¸ Skipped by user" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ§ª **Tests:** â„¹ï¸ Skipped (no tests available)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ No changes to sync" >> $GITHUB_STEP_SUMMARY
          fi
